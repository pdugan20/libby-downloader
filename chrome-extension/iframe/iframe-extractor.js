import{M as c}from"../assets/messages-BdtHrvpp.js";console.log("[Libby Downloader] Iframe script loaded");const w=JSON.parse;window.__odreadCmptParams=null;JSON.parse=function(...o){const e=w.apply(this,o);if(e&&typeof e=="object"&&e!==null){const r=e;if(r.b&&typeof r.b=="object"){const n=r.b;n["-odread-cmpt-params"]&&(window.__odreadCmptParams=Array.from(n["-odread-cmpt-params"]),console.log("[Libby Downloader] Captured crypto parameters"))}}return e};window.addEventListener("message",async o=>{if(!(!o.data||o.data.type!==c.EXTRACT_LIBBY_BOOK)){console.log("[Libby Downloader] Extraction requested");try{const e=await u();console.log(`[Libby Downloader] Extraction complete: "${e.metadata.title}" (${e.chapters.length} chapters)`),window.parent.postMessage({type:c.EXTRACTION_SUCCESS,data:e},"*")}catch(e){const r=e instanceof Error?e.message:"Unknown error";console.error("[Libby Downloader] Extraction failed:",e),window.parent.postMessage({type:c.EXTRACTION_ERROR,error:r},"*")}}});async function u(){const o=await f();if(!o)throw new Error("BIF object not found. The audiobook player may not have loaded properly.");if(!window.__odreadCmptParams)throw new Error("Crypto parameters not captured yet. Play the audiobook for a few seconds and try again.");const e=window.__odreadCmptParams,r=o.map.creator.filter(t=>t.role==="author").map(t=>t.name),n=o.map.creator.filter(t=>t.role==="narrator").map(t=>t.name),m=o.map.spine.reduce((t,a)=>t+(a["audio-duration"]||0),0);let l="";try{const t=o.root?.querySelector("image");t&&(l=t.getAttribute("href")||"")}catch(t){console.warn("[Libby Downloader] Could not extract cover URL:",t)}const i=[];let p=0;for(const t of o.objects.spool.components){const a=location.origin+"/"+t.meta.path+"?"+e[t.spinePosition],s=t.meta["audio-duration"]||t.meta.duration||t.duration||0;i.push({index:t.meta["-odread-spine-position"],title:`Part ${t.meta["-odread-spine-position"]+1}`,url:a,duration:s,startTime:p}),p+=s}if(o.map.nav?.toc){const t=o.map.spine.map(a=>a["-odread-original-path"]);for(const a of o.map.nav.toc){const s=a.path.split("#")[0],d=t.indexOf(s);d!==-1&&i[d]&&(i[d].title=a.title)}}return{metadata:{title:o.map.title.main,authors:r,narrators:n,duration:Math.round(m/60),coverUrl:l,description:o.map.description},chapters:i}}async function f(){let o=window.BIF;if(!o&&typeof window.getBIF=="function"&&(console.log("[Libby Downloader] Calling getBIF()"),o=await window.getBIF()),!o){console.log("[Libby Downloader] Polling for window.BIF");for(let e=0;e<20;e++){if(window.BIF){o=window.BIF,console.log(`[Libby Downloader] Found BIF after ${e+1} attempts`);break}await b(500)}}return o||null}function b(o){return new Promise(e=>setTimeout(e,o))}console.log("[Libby Downloader] Ready to extract");
