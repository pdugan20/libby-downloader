(function(){"use strict";const c={EXTRACT_LIBBY_BOOK:"EXTRACT_LIBBY_BOOK",EXTRACTION_SUCCESS:"EXTRACTION_SUCCESS",EXTRACTION_ERROR:"EXTRACTION_ERROR",START_DOWNLOAD:"START_DOWNLOAD",DOWNLOAD_PROGRESS:"DOWNLOAD_PROGRESS",DOWNLOAD_COMPLETE:"DOWNLOAD_COMPLETE",GET_DOWNLOAD_STATUS:"GET_DOWNLOAD_STATUS",LIBBY_DOWNLOADER_BUTTON_CLICKED:"LIBBY_DOWNLOADER_BUTTON_CLICKED",UPDATE_PROGRESS_UI:"UPDATE_PROGRESS_UI",RESET_UI:"RESET_UI"};console.log("[Libby Downloader] Iframe script loaded");const w=JSON.parse;window.__odreadCmptParams=null,JSON.parse=function(o,e){const a=w.apply(this,[o,e]);if(a&&typeof a=="object"&&a!==null){const n=a;if(n.b&&typeof n.b=="object"){const i=n.b;i["-odread-cmpt-params"]&&(window.__odreadCmptParams=Array.from(i["-odread-cmpt-params"]),console.log("[Libby Downloader] Captured crypto parameters"))}}return a},window.addEventListener("message",async o=>{if(!(!o.data||o.data.type!==c.EXTRACT_LIBBY_BOOK)){console.log("[Libby Downloader] Extraction requested");try{const e=await O();console.log(`[Libby Downloader] Extraction complete: "${e.metadata.title}" (${e.chapters.length} chapters)`),window.parent.postMessage({type:c.EXTRACTION_SUCCESS,data:e},"*")}catch(e){const a=e instanceof Error?e.message:"Unknown error";console.error("[Libby Downloader] Extraction failed:",e),window.parent.postMessage({type:c.EXTRACTION_ERROR,error:a},"*")}}});async function O(){const o=await u();if(!o)throw new Error("BIF object not found. The audiobook player may not have loaded properly.");if(!window.__odreadCmptParams)throw new Error("Crypto parameters not captured yet. Play the audiobook for a few seconds and try again.");const e=window.__odreadCmptParams,a=o.map.creator.filter(t=>t.role==="author").map(t=>t.name),n=o.map.creator.filter(t=>t.role==="narrator").map(t=>t.name),i=o.map.spine.reduce((t,r)=>t+(r["audio-duration"]||0),0);let p="";try{const t=o.root?.querySelector("image");t&&(p=t.getAttribute("href")||"")}catch(t){console.warn("[Libby Downloader] Could not extract cover URL:",t)}const s=[];let m=0;for(const t of o.objects.spool.components){const r=location.origin+"/"+t.meta.path+"?"+e[t.spinePosition],d=t.meta["audio-duration"]||t.meta.duration||t.duration||0;s.push({index:t.meta["-odread-spine-position"],title:`Part ${t.meta["-odread-spine-position"]+1}`,url:r,duration:d,startTime:m}),m+=d}if(o.map.nav?.toc){const t=o.map.spine.map(r=>r["-odread-original-path"]);for(const r of o.map.nav.toc){const d=r.path.split("#")[0],l=t.indexOf(d);l!==-1&&s[l]&&(s[l].title=r.title)}}return{metadata:{title:o.map.title.main,authors:a,narrators:n,duration:Math.round(i/60),coverUrl:p,description:o.map.description},chapters:s}}async function u(){let o=window.BIF;if(!o&&typeof window.getBIF=="function"&&(console.log("[Libby Downloader] Calling getBIF()"),o=await window.getBIF()),!o){console.log("[Libby Downloader] Polling for window.BIF");for(let e=0;e<20;e++){if(window.BIF){o=window.BIF,console.log(`[Libby Downloader] Found BIF after ${e+1} attempts`);break}await T(500)}}return o||null}function T(o){return new Promise(e=>setTimeout(e,o))}console.log("[Libby Downloader] Ready to extract")})();
