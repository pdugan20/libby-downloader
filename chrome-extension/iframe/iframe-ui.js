(function(){"use strict";const s={LIBBY_DOWNLOADER_BUTTON_CLICKED:"LIBBY_DOWNLOADER_BUTTON_CLICKED",UPDATE_PROGRESS_UI:"UPDATE_PROGRESS_UI",RESET_UI:"RESET_UI"};console.log("[Libby Downloader] Iframe UI script loaded");let l=null,i=null;function g(){const n=[".backdrop-cover-button",".slingshot",".title-tile-cover",".title-tile",".player-art",".album-art"];for(const e of n){const o=document.querySelector(e);if(o)return console.log(`[Libby Downloader] Found album art: ${e}`),o}return console.warn("[Libby Downloader] Could not find album art container"),null}function d(){if(console.log("[Libby Downloader] createProgressOverlay called"),l){console.log("[Libby Downloader] Overlay already exists, returning");return}if(console.log("[Libby Downloader] Finding album art container..."),i=g(),!i){console.warn("[Libby Downloader] Cannot create progress overlay - album art not found");return}console.log("[Libby Downloader] Album art found, creating overlay elements...");const n=document.createElement("div");n.className="libby-download-progress-overlay";const e=document.createElement("div");e.className="libby-progress-container";const o=document.createElement("div");o.className="libby-progress-bar";const t=document.createElement("div");t.className="libby-progress-fill",o.appendChild(t);const r=document.createElement("div");r.className="libby-progress-text",r.textContent="Preparing download...",e.appendChild(o),e.appendChild(r),n.appendChild(e),document.body.appendChild(n),l=n,console.log("[Libby Downloader] Progress overlay created")}function b(n,e,o){if(console.log("[Libby Downloader] updateProgressOverlay called",{completed:n,total:e,message:o,hasOverlay:!!l}),l||(console.log("[Libby Downloader] No overlay exists, creating one..."),d()),!l){console.warn("[Libby Downloader] Still no overlay after create attempt, returning");return}console.log("[Libby Downloader] Updating overlay elements");const t=l.querySelector(".libby-progress-fill"),r=l.querySelector(".libby-progress-text");if(t){const a=e>0?n/e*100:0;t.style.width=`${a}%`,console.log("[Libby Downloader] Updated progress fill to",a+"%")}r&&(r.textContent=o,console.log("[Libby Downloader] Updated progress text to",o))}function u(n){if(!l)return;const e=l.querySelector(".libby-progress-text");e&&(n===0?e.innerHTML=`
        <svg class="libby-checkmark" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <path d="M24 42.17L12.83 31L8.41 35.41L24 51L56 19L51.59 14.59L24 42.17Z" fill="currentColor"/>
        </svg>
        Download complete!
      `:e.innerHTML=`Download complete with ${n} errors`,e.classList.add("libby-completion-message"))}function y(){l&&(l.remove(),l=null),i=null}window.addEventListener("message",n=>{if(!n.data||typeof n.data!="object"||!n.data.type)return;console.log("[Libby Downloader] Iframe received extension message:",n.data);const{type:e,state:o,data:t}=n.data;switch(console.log(`[Libby Downloader] Message type: ${e}, state: ${o}`),e){case s.UPDATE_PROGRESS_UI:console.log("[Libby Downloader] UPDATE_PROGRESS_UI matched"),o==="extracting"?(console.log("[Libby Downloader] Creating progress overlay for extracting"),d(),b(0,1,"Extracting metadata...")):o==="downloading"&&t?(console.log("[Libby Downloader] Updating progress for downloading"),b(t.completed||0,t.total||1,t.message||"Downloading...")):o==="success"&&t&&(console.log("[Libby Downloader] Showing completion message"),u(t.failedChapters||0));break;case s.RESET_UI:console.log("[Libby Downloader] RESET_UI matched"),y();break;default:console.log(`[Libby Downloader] Unhandled message type: ${e}`)}});function c(){const n=document.querySelector(".nav-action-bar-right");if(!n){console.log("[Libby Downloader] Nav bar not found yet, waiting..."),setTimeout(c,100);return}console.log("[Libby Downloader] Nav bar found, injecting button...");const e=document.createElement("div");e.className="nav-action-item",e.id="libby-downloader-button-container";const o=document.createElement("button");o.id="libby-downloader-button",o.className="nav-action-item-button halo",o.type="button",o.setAttribute("aria-label","Download Audiobook"),o.setAttribute("touch-action","none");const t=document.createElement("div");t.className="nav-action-item-icon",t.style.transform="scale(0.7)",t.innerHTML=`
    <svg viewBox="0 0 90 66" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path class="icon-fill" d="M45 0C51.9047 0 58.828 2.60948 64.0938 7.875C68.18 11.9613 70.6146 17.074 71.5312 22.375C81.9872 24.0733 90 33.0815 90 44C90 56.1265 80.1265 66 68 66H19C8.5086 66 0 57.4914 0 47C0 36.7863 8.0804 28.5278 18.1875 28.0938C17.895 20.817 20.3931 13.4194 25.9375 7.875C31.1999 2.61245 38.0953 0 45 0ZM45 4C39.1085 4 33.2504 6.2183 28.75 10.7188C23.5485 15.9202 21.3768 22.9839 22.1875 29.75C22.2231 30.0328 22.1979 30.32 22.1134 30.5923C22.029 30.8646 21.8873 31.1157 21.6979 31.3287C21.5086 31.5418 21.2758 31.7119 21.0153 31.8277C20.7548 31.9435 20.4726 32.0022 20.1875 32H19C10.6554 32 4 38.6554 4 47C4 55.3446 10.6554 62 19 62H68C77.9647 62 86 53.9647 86 44C86 34.5907 78.8314 26.8955 69.6562 26.0625C69.1992 26.0228 68.7698 25.8273 68.4398 25.5087C68.1099 25.1901 67.8995 24.7678 67.8438 24.3125C67.2668 19.3422 65.0999 14.5373 61.2812 10.7188C56.7838 6.22127 50.8915 4 45 4ZM45 24C46.1048 24 47 24.8954 47 26V47.5L54.6562 40.5313C55.4326 39.8225 56.7943 39.877 57.5 40.6563C58.2056 41.4357 58.1657 42.7846 57.3438 43.5L46.3438 53.5C46.058 53.7618 45.5349 53.99 45 54C44.4692 54 44.0965 53.902 43.6562 53.5L32.6562 43.5C31.8737 42.7978 31.7299 41.4276 32.5 40.6563C33.2428 39.9122 34.5674 39.8225 35.3438 40.5313L43 47.5V26C43 24.8954 43.8952 24 45 24Z" fill="currentColor"/>
    </svg>
  `,o.appendChild(t),e.appendChild(o);const r=n.querySelectorAll(".nav-action-item");if(r.length>0){const a=r[r.length-1];n.insertBefore(e,a)}else n.appendChild(e);o.addEventListener("click",()=>{console.log("[Libby Downloader] Download button clicked in iframe"),window.parent.postMessage({type:s.LIBBY_DOWNLOADER_BUTTON_CLICKED},"*")}),console.log("[Libby Downloader] Button injected successfully")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c()})();
