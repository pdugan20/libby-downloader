(function(){"use strict";const s={READY:"ready",EXTRACTING:"extracting",DOWNLOADING:"downloading",SUCCESS:"success",ERROR:"error"},g={BUTTON_RESET:3e3},p={BUTTON_ID:"libby-downloader-button",NOTIFICATION_CLASS:"libby-downloader-notification",Z_INDEX:999999};class l extends Error{constructor(e){super(e),this.name="LibbyDownloaderError",Object.setPrototypeOf(this,l.prototype)}}class d extends l{constructor(e,t){super(e),this.cause=t,this.name="ExtractionError",Object.setPrototypeOf(this,d.prototype)}}class u extends l{constructor(e,t){super(e),this.invalidData=t,this.name="ValidationError",Object.setPrototypeOf(this,u.prototype)}}class h extends l{constructor(e,t){super(e),this.origin=t,this.name="IframeError",Object.setPrototypeOf(this,h.prototype)}}class f extends l{constructor(e,t){super(e),this.timeoutMs=t,this.name="TimeoutError",Object.setPrototypeOf(this,f.prototype)}}const a={EXTRACT_LIBBY_BOOK:"EXTRACT_LIBBY_BOOK",EXTRACTION_SUCCESS:"EXTRACTION_SUCCESS",EXTRACTION_ERROR:"EXTRACTION_ERROR",START_DOWNLOAD:"START_DOWNLOAD",DOWNLOAD_PROGRESS:"DOWNLOAD_PROGRESS",DOWNLOAD_COMPLETE:"DOWNLOAD_COMPLETE",GET_DOWNLOAD_STATUS:"GET_DOWNLOAD_STATUS",LIBBY_DOWNLOADER_BUTTON_CLICKED:"LIBBY_DOWNLOADER_BUTTON_CLICKED",UPDATE_PROGRESS_UI:"UPDATE_PROGRESS_UI",RESET_UI:"RESET_UI"};class E{currentLevel;prefix="[Libby Downloader]";constructor(){this.currentLevel=1}setLevel(e){this.currentLevel=e}debug(e,t){this.currentLevel<=0&&(t?console.log(`${this.prefix} [DEBUG]`,e,t):console.log(`${this.prefix} [DEBUG]`,e))}info(e,t){this.currentLevel<=1&&(t?console.log(`${this.prefix}`,e,t):console.log(`${this.prefix}`,e))}warn(e,t){this.currentLevel<=2&&(t?console.warn(`${this.prefix} [WARN]`,e,t):console.warn(`${this.prefix} [WARN]`,e))}error(e,t,o){this.currentLevel<=3&&(t instanceof Error?console.error(`${this.prefix} [ERROR]`,e,{error:t.message,stack:void 0,...o}):t!==void 0?console.error(`${this.prefix} [ERROR]`,e,{error:t,...o}):o?console.error(`${this.prefix} [ERROR]`,e,o):console.error(`${this.prefix} [ERROR]`,e))}operationStart(e,t){this.debug(`Starting: ${e}`,t)}operationComplete(e,t){this.debug(`Completed: ${e}`,t)}operationFailed(e,t,o){this.error(`Failed: ${e}`,t,o)}}const n=new E,m=[/^https:\/\/([a-z0-9-]+\.)?listen\.libbyapp\.com$/,/^https:\/\/([a-z0-9-]+\.)?thunder\.libbyapp\.com$/];function O(i){return i===window.location.origin?!0:m.some(e=>e.test(i))}function b(i){if(!i||typeof i!="object")return!1;const e=i;if(!e.metadata||typeof e.metadata!="object")return!1;const{metadata:t,chapters:o}=e;if(!t.title||typeof t.title!="string"||!Array.isArray(t.authors)||t.authors.length===0||!Array.isArray(o)||o.length===0)return!1;const r=o[0];return!(typeof r.index!="number"||typeof r.title!="string"||typeof r.url!="string"||typeof r.duration!="number")}class T{uiManager;extractionTimeout=null;constructor(e){this.uiManager=e}setupListeners(){window.addEventListener("message",e=>this.handleWindowMessage(e)),chrome.runtime.onMessage.addListener(e=>this.handleBackgroundMessage(e))}handleWindowMessage(e){if(!O(e.origin)){n.warn("Rejected message from untrusted origin",{origin:e.origin});return}const{type:t,data:o,error:r}=e.data;switch(t){case"LIBBY_DOWNLOADER_BUTTON_CLICKED":this.handleButtonClick();break;case a.EXTRACTION_SUCCESS:o&&this.handleExtractionSuccess(o);break;case a.EXTRACTION_ERROR:r&&this.handleExtractionError(r);break}}handleButtonClick(){try{n.operationStart("Button click handling");const e=document.getElementsByTagName("iframe");let t=null;for(const o of Array.from(e))if(o.src&&o.src.includes("listen.libbyapp.com")){t=o;break}if(!t)throw new h("Could not find audiobook iframe on page");this.uiManager.setIframe(t),this.requestExtraction(t),n.operationComplete("Button click handling")}catch(e){n.operationFailed("Button click handling",e);const t=e instanceof Error?e.message:"Failed to find audiobook iframe";this.uiManager.showError(t)}}handleBackgroundMessage(e){const{type:t}=e;switch(t){case a.DOWNLOAD_PROGRESS:this.handleDownloadProgress(e.progress);break;case a.DOWNLOAD_COMPLETE:this.handleDownloadComplete(e.result);break}}requestExtraction(e){n.operationStart("Book extraction request"),this.uiManager.updateState("extracting");let t="https://listen.libbyapp.com";try{t=new URL(e.src).origin}catch{console.warn("[Libby Downloader] Failed to parse iframe URL, using fallback origin")}e.contentWindow&&e.contentWindow.postMessage({type:a.EXTRACT_LIBBY_BOOK},t),this.extractionTimeout=window.setTimeout(()=>{const o=new f("Extraction timeout. Try playing the audiobook for a few seconds first.",1e4);n.operationFailed("Book extraction",o),this.uiManager.showError(o.message)},1e4)}async handleExtractionSuccess(e){try{if(this.extractionTimeout!==null&&clearTimeout(this.extractionTimeout),n.operationComplete("Book extraction",{title:e.metadata.title,chapters:e.chapters.length}),!b(e))throw new u("Invalid book data received from extraction",e);this.uiManager.updateState("downloading",{completed:0,total:e.chapters.length});const t=await chrome.runtime.sendMessage({type:a.START_DOWNLOAD,data:e});if(!t.success)throw new Error(t.error);n.operationComplete("Download start")}catch(t){n.operationFailed("Download",t);const o=t instanceof Error?t.message:"Unknown error";this.uiManager.showError(`Download failed: ${o}`)}}handleExtractionError(e){this.extractionTimeout!==null&&clearTimeout(this.extractionTimeout);const t=new d(e);n.operationFailed("Book extraction",t),this.uiManager.showError(`Extraction failed: ${e}`)}handleDownloadProgress(e){const{completed:t,total:o}=e;this.uiManager.updateState("downloading",{completed:t,total:o})}handleDownloadComplete(e){const{completed:t,failed:o,total:r}=e;this.uiManager.updateState("success",{completedChapters:t,failedChapters:o,totalChapters:r}),this.uiManager.resetAfterDelay()}}class R{libbyIframe=null;createButton(e){const t=document.querySelector(".nav-action-bar-right");if(!t){console.error("[Libby Downloader] Could not find nav-action-bar-right");return}try{const o=document.createElement("div");o.className="nav-action-item",o.id=p.BUTTON_ID+"-container";const r=document.createElement("button");r.id=p.BUTTON_ID,r.className="nav-action-item-button halo",r.type="button",r.setAttribute("aria-label","Download Audiobook"),r.setAttribute("touch-action","none");const c=document.createElement("div");c.className="nav-action-item-icon",c.innerHTML=`
        <svg viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">
            <path class="icon-fill" d="M32 42L20 30L23.5 26.5L29 32V16H35V32L40.5 26.5L44 30L32 42Z" fill="currentColor"/>
            <path class="icon-fill" d="M16 52C14.9 52 13.958 51.608 13.174 50.824C12.39 50.04 12 49.099 12 48V40H16V48H48V40H52V48C52 49.1 51.61 50.042 50.83 50.826C50.05 51.61 49.099 52 48 52H16Z" fill="currentColor"/>
          </g>
        </svg>
      `,r.appendChild(c),o.appendChild(r),t.appendChild(o),r.addEventListener("click",e)}catch(o){console.error("[Libby Downloader] Error creating button:",o)}}updateState(e,t={}){switch(e){case s.EXTRACTING:this.sendIframeMessage(a.UPDATE_PROGRESS_UI,"extracting");break;case s.DOWNLOADING:{const o=t,{completed:r,total:c}=o;this.sendIframeMessage(a.UPDATE_PROGRESS_UI,"downloading",{completed:r,total:c,message:`Downloading ${r} of ${c} chapters`});break}case s.SUCCESS:{const o=t,{failedChapters:r}=o;this.sendIframeMessage(a.UPDATE_PROGRESS_UI,"success",{failedChapters:r});break}case s.ERROR:this.sendIframeMessage(a.RESET_UI);break;case s.READY:default:this.sendIframeMessage(a.RESET_UI);break}}setIframe(e){this.libbyIframe=e,n.debug("Libby iframe set for UI manager")}sendIframeMessage(e,t,o){if(!this.libbyIframe||!this.libbyIframe.contentWindow){n.warn("Cannot send message - iframe not set");return}const r=new URL(this.libbyIframe.src).origin;n.debug("Sending iframe message",{type:e,state:t,data:o,targetOrigin:r}),this.libbyIframe.contentWindow.postMessage({type:e,state:t,data:o},r)}resetAfterDelay(){setTimeout(()=>{this.updateState(s.READY)},g.BUTTON_RESET)}showError(e){alert(`‚ùå ${e}`),this.updateState(s.ERROR)}}console.log("[Libby Downloader] Content script loaded");{if(!window.location.pathname.includes("/open/loan/"))throw console.log("[Libby Downloader] Not an audiobook page"),new Error("Not an audiobook page");console.log("[Libby Downloader] Audiobook page detected")}const w=new R;new T(w).setupListeners(),console.log("[Libby Downloader] Ready - waiting for button click from iframe")})();
