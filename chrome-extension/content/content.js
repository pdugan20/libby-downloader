(function(){"use strict";const a={READY:"ready",EXTRACTING:"extracting",DOWNLOADING:"downloading",SUCCESS:"success",ERROR:"error"},w={NOTIFICATION_DURATION:3e3,BUTTON_RESET:3e3},u={BUTTON_ID:"libby-downloader-button",NOTIFICATION_CLASS:"libby-downloader-notification",Z_INDEX:999999};class l extends Error{constructor(e){super(e),this.name="LibbyDownloaderError",Object.setPrototypeOf(this,l.prototype)}}class h extends l{constructor(e,t){super(e),this.cause=t,this.name="ExtractionError",Object.setPrototypeOf(this,h.prototype)}}class p extends l{constructor(e,t){super(e),this.invalidData=t,this.name="ValidationError",Object.setPrototypeOf(this,p.prototype)}}class f extends l{constructor(e,t){super(e),this.origin=t,this.name="IframeError",Object.setPrototypeOf(this,f.prototype)}}class g extends l{constructor(e,t){super(e),this.timeoutMs=t,this.name="TimeoutError",Object.setPrototypeOf(this,g.prototype)}}const c={EXTRACT_LIBBY_BOOK:"EXTRACT_LIBBY_BOOK",EXTRACTION_SUCCESS:"EXTRACTION_SUCCESS",EXTRACTION_ERROR:"EXTRACTION_ERROR",START_DOWNLOAD:"START_DOWNLOAD",DOWNLOAD_PROGRESS:"DOWNLOAD_PROGRESS",DOWNLOAD_COMPLETE:"DOWNLOAD_COMPLETE",GET_DOWNLOAD_STATUS:"GET_DOWNLOAD_STATUS",LIBBY_DOWNLOADER_BUTTON_CLICKED:"LIBBY_DOWNLOADER_BUTTON_CLICKED"};class C{currentLevel;prefix="[Libby Downloader]";constructor(){this.currentLevel=1}setLevel(e){this.currentLevel=e}debug(e,t){this.currentLevel<=0&&(t?console.log(`${this.prefix} [DEBUG]`,e,t):console.log(`${this.prefix} [DEBUG]`,e))}info(e,t){this.currentLevel<=1&&(t?console.log(`${this.prefix}`,e,t):console.log(`${this.prefix}`,e))}warn(e,t){this.currentLevel<=2&&(t?console.warn(`${this.prefix} [WARN]`,e,t):console.warn(`${this.prefix} [WARN]`,e))}error(e,t,o){this.currentLevel<=3&&(t instanceof Error?console.error(`${this.prefix} [ERROR]`,e,{error:t.message,stack:void 0,...o}):t!==void 0?console.error(`${this.prefix} [ERROR]`,e,{error:t,...o}):o?console.error(`${this.prefix} [ERROR]`,e,o):console.error(`${this.prefix} [ERROR]`,e))}operationStart(e,t){this.debug(`Starting: ${e}`,t)}operationComplete(e,t){this.debug(`Completed: ${e}`,t)}operationFailed(e,t,o){this.error(`Failed: ${e}`,t,o)}}const i=new C,b=[/^https:\/\/([a-z0-9-]+\.)?listen\.libbyapp\.com$/,/^https:\/\/([a-z0-9-]+\.)?thunder\.libbyapp\.com$/];function m(n){return n===window.location.origin?!0:b.some(e=>e.test(n))}function E(n){if(!n||typeof n!="object")return!1;const e=n;if(!e.metadata||typeof e.metadata!="object")return!1;const{metadata:t,chapters:o}=e;if(!t.title||typeof t.title!="string"||!Array.isArray(t.authors)||t.authors.length===0||!Array.isArray(o)||o.length===0)return!1;const r=o[0];return!(typeof r.index!="number"||typeof r.title!="string"||typeof r.url!="string"||typeof r.duration!="number")}class O{uiManager;extractionTimeout=null;constructor(e){this.uiManager=e}setupListeners(){window.addEventListener("message",e=>this.handleWindowMessage(e)),chrome.runtime.onMessage.addListener(e=>this.handleBackgroundMessage(e))}handleWindowMessage(e){if(!m(e.origin)){i.warn("Rejected message from untrusted origin",{origin:e.origin});return}const{type:t,data:o,error:r}=e.data;switch(t){case"LIBBY_DOWNLOADER_BUTTON_CLICKED":this.handleButtonClick();break;case c.EXTRACTION_SUCCESS:o&&this.handleExtractionSuccess(o);break;case c.EXTRACTION_ERROR:r&&this.handleExtractionError(r);break}}handleButtonClick(){try{i.operationStart("Button click handling");const e=document.getElementsByTagName("iframe");let t=null;for(const o of Array.from(e))if(o.src&&o.src.includes("listen.libbyapp.com")){t=o;break}if(!t)throw new f("Could not find audiobook iframe on page");this.requestExtraction(t),i.operationComplete("Button click handling")}catch(e){i.operationFailed("Button click handling",e);const t=e instanceof Error?e.message:"Failed to find audiobook iframe";this.uiManager.showError(t)}}handleBackgroundMessage(e){const{type:t}=e;switch(t){case c.DOWNLOAD_PROGRESS:this.handleDownloadProgress(e.progress);break;case c.DOWNLOAD_COMPLETE:this.handleDownloadComplete(e.result);break}}requestExtraction(e){i.operationStart("Book extraction request"),this.uiManager.updateState("extracting");let t="https://listen.libbyapp.com";try{t=new URL(e.src).origin}catch{console.warn("[Libby Downloader] Failed to parse iframe URL, using fallback origin")}e.contentWindow&&e.contentWindow.postMessage({type:c.EXTRACT_LIBBY_BOOK},t),this.extractionTimeout=window.setTimeout(()=>{const o=new g("Extraction timeout. Try playing the audiobook for a few seconds first.",1e4);i.operationFailed("Book extraction",o),this.uiManager.showError(o.message)},1e4)}async handleExtractionSuccess(e){try{if(this.extractionTimeout!==null&&clearTimeout(this.extractionTimeout),i.operationComplete("Book extraction",{title:e.metadata.title,chapters:e.chapters.length}),!E(e))throw new p("Invalid book data received from extraction",e);this.uiManager.updateState("downloading",{completed:0,total:e.chapters.length});const t=await chrome.runtime.sendMessage({type:c.START_DOWNLOAD,data:e});if(!t.success)throw new Error(t.error);i.operationComplete("Download start")}catch(t){i.operationFailed("Download",t);const o=t instanceof Error?t.message:"Unknown error";this.uiManager.showError(`Download failed: ${o}`)}}handleExtractionError(e){this.extractionTimeout!==null&&clearTimeout(this.extractionTimeout);const t=new h(e);i.operationFailed("Book extraction",t),this.uiManager.showError(`Extraction failed: ${e}`)}handleDownloadProgress(e){const{completed:t,total:o}=e;this.uiManager.updateState("downloading",{completed:t,total:o})}handleDownloadComplete(e){const{completed:t,failed:o,total:r}=e;this.uiManager.updateState("success",{completedChapters:t,failedChapters:o,totalChapters:r}),o===0?this.uiManager.showNotification(`Successfully downloaded ${t} chapters!`):this.uiManager.showNotification(`Downloaded ${t} chapters (${o} failed)`),this.uiManager.resetAfterDelay()}}const T={download:`<svg viewBox="0 0 90 66" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="icon-fill" d="M45 0C51.9047 0 58.828 2.60948 64.0938 7.875C68.18 11.9613 70.6146 17.074 71.5312 22.375C81.9872 24.0733 90 33.0815 90 44C90 56.1265 80.1265 66 68 66H19C8.5086 66 0 57.4914 0 47C0 36.7863 8.0804 28.5278 18.1875 28.0938C17.895 20.817 20.3931 13.4194 25.9375 7.875C31.1999 2.61245 38.0953 0 45 0ZM45 4C39.1085 4 33.2504 6.2183 28.75 10.7188C23.5485 15.9202 21.3768 22.9839 22.1875 29.75C22.2231 30.0328 22.1979 30.32 22.1134 30.5923C22.029 30.8646 21.8873 31.1157 21.6979 31.3287C21.5086 31.5418 21.2758 31.7119 21.0153 31.8277C20.7548 31.9435 20.4726 32.0022 20.1875 32H19C10.6554 32 4 38.6554 4 47C4 55.3446 10.6554 62 19 62H68C77.9647 62 86 53.9647 86 44C86 34.5907 78.8314 26.8955 69.6562 26.0625C69.1992 26.0228 68.7698 25.8273 68.4398 25.5087C68.1099 25.1901 67.8995 24.7678 67.8438 24.3125C67.2668 19.3422 65.0999 14.5373 61.2812 10.7188C56.7838 6.22127 50.8915 4 45 4ZM45 24C46.1048 24 47 24.8954 47 26V47.5L54.6562 40.5313C55.4326 39.8225 56.7943 39.877 57.5 40.6563C58.2056 41.4357 58.1657 42.7846 57.3438 43.5L46.3438 53.5C46.058 53.7618 45.5349 53.99 45 54C44.4692 54 44.0965 53.902 43.6562 53.5L32.6562 43.5C31.8737 42.7978 31.7299 41.4276 32.5 40.6563C33.2428 39.9122 34.5674 39.8225 35.3438 40.5313L43 47.5V26C43 24.8954 43.8952 24 45 24Z" fill="currentColor"/>
</svg>
`,spinner:`<svg class="spinner" viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" fill-rule="evenodd" stroke="none" stroke-linecap="round" stroke-width="1">
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" x1="32" x2="32" y1="12.875" y2="16.125"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.9" x1="41.6" x2="43.85" y1="14.15" y2="16.4"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.8" x1="47.85" x2="49.85" y1="22.4" y2="24.4"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.7" x1="49.85" x2="51.125" y1="32" y2="32"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.6" x1="47.85" x2="49.85" y1="41.6" y2="39.6"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.5" x1="41.6" x2="43.85" y1="49.85" y2="47.6"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.4" x1="32" x2="32" y1="51.125" y2="47.875"></line>
    <line class="icon-hollow" stroke="currentColor" stroke-width="3" opacity="0.3" x1="22.4" x2="20.15" y1="49.85" y2="47.6"></line>
  </g>
</svg>
`,checkmark:`<svg viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">
    <path class="icon-fill" d="M24 42.17L12.83 31L8.41 35.41L24 51L56 19L51.59 14.59L24 42.17Z" fill="currentColor"/>
  </g>
</svg>
`,error:`<svg viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">
    <path class="icon-fill" d="M32 6C17.64 6 6 17.64 6 32s11.64 26 26 26 26-11.64 26-26S46.36 6 32 6zm3 39h-6v-6h6v6zm0-12h-6V18h6v15z" fill="currentColor"/>
  </g>
</svg>
`};function d(n){return T[n]}class y{button=null;iconContainer=null;createButton(e){const t=document.querySelector(".nav-action-bar-right");if(!t){console.error("[Libby Downloader] Could not find nav-action-bar-right");return}try{const o=document.createElement("div");o.className="nav-action-item",o.id=u.BUTTON_ID+"-container";const r=document.createElement("button");r.id=u.BUTTON_ID,r.className="nav-action-item-button halo",r.type="button",r.setAttribute("aria-label","Download Audiobook"),r.setAttribute("touch-action","none");const s=document.createElement("div");s.className="nav-action-item-icon",s.innerHTML=`
        <svg viewBox="0 0 64 64" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd" stroke="none" stroke-width="1">
            <path class="icon-fill" d="M32 42L20 30L23.5 26.5L29 32V16H35V32L40.5 26.5L44 30L32 42Z" fill="currentColor"/>
            <path class="icon-fill" d="M16 52C14.9 52 13.958 51.608 13.174 50.824C12.39 50.04 12 49.099 12 48V40H16V48H48V40H52V48C52 49.1 51.61 50.042 50.83 50.826C50.05 51.61 49.099 52 48 52H16Z" fill="currentColor"/>
          </g>
        </svg>
      `,r.appendChild(s),o.appendChild(r),t.appendChild(o),r.addEventListener("click",e),this.button=r,this.iconContainer=s}catch(o){console.error("[Libby Downloader] Error creating button:",o)}}updateState(e,t={}){if(!(!this.button||!this.iconContainer))switch(e){case a.EXTRACTING:this.iconContainer.innerHTML=d("spinner"),this.button.setAttribute("aria-label","Extracting metadata..."),this.button.disabled=!0;break;case a.DOWNLOADING:{const o=t,{completed:r,total:s}=o;this.iconContainer.innerHTML=d("spinner"),this.button.setAttribute("aria-label",`Downloading ${r}/${s} chapters...`),this.button.disabled=!0;break}case a.SUCCESS:{const o=t,{completedChapters:r,failedChapters:s,totalChapters:D}=o;this.iconContainer.innerHTML=d("checkmark"),s===0?this.button.setAttribute("aria-label",`Downloaded ${r} chapters successfully!`):this.button.setAttribute("aria-label",`Downloaded ${r}/${D} chapters (${s} failed)`);break}case a.ERROR:this.iconContainer.innerHTML=d("error"),this.button.setAttribute("aria-label","Error - Click to retry"),this.button.disabled=!1;break;case a.READY:default:this.iconContainer.innerHTML=d("download"),this.button.setAttribute("aria-label","Download Audiobook"),this.button.disabled=!1;break}}resetAfterDelay(){setTimeout(()=>{this.updateState(a.READY)},w.BUTTON_RESET)}showError(e){alert(`âŒ ${e}`),this.updateState(a.ERROR)}showNotification(e){const t=document.createElement("div");t.className=u.NOTIFICATION_CLASS,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease-out",setTimeout(()=>t.remove(),300)},w.NOTIFICATION_DURATION)}}console.log("[Libby Downloader] Content script loaded");{if(!window.location.pathname.includes("/open/loan/"))throw console.log("[Libby Downloader] Not an audiobook page"),new Error("Not an audiobook page");console.log("[Libby Downloader] Audiobook page detected")}const L=new y;new O(L).setupListeners(),console.log("[Libby Downloader] Ready - waiting for button click from iframe")})();
