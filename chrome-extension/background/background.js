import{T as u,D as w,M as c}from"../assets/messages-CwU8PCpU.js";import{s as p,l as d,D as h}from"../assets/validators-D715d9sk.js";class m{async downloadChapter(o,a,e){const t=String(e+1).padStart(3,"0"),r=`libby-downloads/${p(a)}/chapter-${t}.mp3`;d.operationStart(`Download chapter ${e+1}`,{title:o.title,filename:r});const n=await chrome.downloads.download({url:o.url,filename:r,saveAs:!1}),s=await this.waitForDownload(n);return{downloadId:n,filepath:s,chapterIndex:e}}async downloadAllChapters(o,a,e){const t={completed:0,failed:0,total:o.length,downloadIds:[],errors:[]};for(let r=0;r<o.length;r++)try{const n=await this.downloadChapter(o[r],a,r);t.downloadIds.push(n.downloadId),t.completed++,d.operationComplete(`Download chapter ${r+1}/${o.length}`),e&&e(t.completed,t.total),await this.sleep(u.DOWNLOAD_DELAY)}catch(n){const s=new h(`Failed to download chapter ${r+1}`,r,n instanceof Error?n:void 0);d.operationFailed(`Download chapter ${r+1}`,s),t.failed++,t.errors.push({chapterIndex:r,error:n instanceof Error?n.message:"Unknown error"})}return t}waitForDownload(o){return new Promise((a,e)=>{const t=setInterval(async()=>{const r=await chrome.downloads.search({id:o});if(r.length===0){clearInterval(t),e(new Error("Download not found"));return}const n=r[0];n.state==="complete"&&(clearInterval(t),n.filename?a(n.filename):e(new Error("Download completed but filename is undefined"))),(n.state==="interrupted"||n.error)&&(clearInterval(t),e(new Error(n.error||"Download interrupted")))},500)})}sleep(o){return new Promise(a=>setTimeout(a,o))}}class f{activeDownloads=new Map;createDownload(o){const a=`${Date.now()}`,{metadata:e,chapters:t}=o,r={bookId:a,metadata:e,totalChapters:t.length,completedChapters:0,failedChapters:0,downloadIds:[],startTime:Date.now(),status:w.DOWNLOADING};return this.activeDownloads.set(a,r),a}updateProgress(o,a,e=0){const t=this.activeDownloads.get(o);t&&(t.completedChapters=a,t.failedChapters=e)}completeDownload(o,a){const e=this.activeDownloads.get(o);e&&(e.status=w.COMPLETE,e.endTime=Date.now(),e.completedChapters=a.completed,e.failedChapters=a.failed)}getDownloadStatus(o){return this.activeDownloads.get(o)||null}removeDownload(o){this.activeDownloads.delete(o)}}class D{async saveMetadata(o,a,e){const t=JSON.stringify({metadata:o,chapters:a},null,2),r="data:application/json;charset=utf-8,"+encodeURIComponent(t);return await chrome.downloads.download({url:r,filename:`libby-downloads/${p(e)}/metadata.json`,saveAs:!1})}}d.info("Background service worker loaded");const g=new m,i=new f,v=new D;async function y(l,o){const{metadata:a,chapters:e}=l;d.info("Starting download",{title:a.title,chapters:e.length});const t=i.createDownload(l),r=await g.downloadAllChapters(e,a.title,(n,s)=>{i.updateProgress(t,n),chrome.tabs.sendMessage(o,{type:c.DOWNLOAD_PROGRESS,progress:{completed:n,total:s}}).catch(()=>{})});i.completeDownload(t,r);try{await v.saveMetadata(a,e,a.title)}catch(n){console.error("[Libby Downloader] Failed to save metadata file:",n)}return chrome.tabs.sendMessage(o,{type:c.DOWNLOAD_COMPLETE,result:{completed:r.completed,failed:r.failed,total:r.total}}).catch(()=>{}),{bookId:t,completed:r.completed,failed:r.failed,total:r.total}}chrome.runtime.onMessage.addListener((l,o,a)=>{if(d.debug("Received message",{type:l.type}),l.type===c.START_DOWNLOAD){const e=o.tab?.id;return e?(y(l.data,e).then(t=>a({success:!0,result:t})).catch(t=>a({success:!1,error:t instanceof Error?t.message:"Unknown error"})),!0):(a({success:!1,error:"No tab ID available"}),!0)}if(l.type===c.GET_DOWNLOAD_STATUS){const e=i.getDownloadStatus(l.bookId);return a({status:e}),!0}return!1});chrome.downloads.onChanged.addListener(l=>{l.error&&console.error(`[Libby Downloader] Download ${l.id} error:`,l.error.current)});d.info("Background service worker ready");
